<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Steves Barbearia - Sistema de Gestão</title>
    <link rel="icon" type="image/png" href="data:image/png;base64,iVBORw0KGgoAAAANSUEUgAAACAAAAAgCAYAAABzenr0AAAAAXNSR0IArs4c6QAAAnZJREFUWEftl01IVFEUx3/nvWmyD6MoqEYLzaKgoI0FQUIFQkEtjanRKGhjRBQVLWzXLiKINi0KWgRBgRAtkkIzLSKINi0qKhNaVKBTkGVqOs37cSPHmXnj+HzvjRU0F2bnvXP+v3PuOfeec4WUj4lZl/8ZIK0O/DsOpACQUmAi4RUCVACNQBVQCeSAaeAr8AwYBX45fS0isCPYBRwDdgM5wEGFRGD/gE/AQ+AGMOkWwg2gEbgI7ANSpRSP0AZcBZps4Z0A6oHLwDbPPMv2SBrYGgRCKRSv7DmgTGtyFGgD3kYF4AQ4D5xVgAUrPclZyZXNiRnPURB1cxp4D6S1qEvAaSewWIJcAE4EtO6vQIsC7NDazgCDwLSa3wYc0XWHxo+APmAsSkQ3pxPACaAOWKm1adXXrXqtlQPj+rzY5hJwV8F4AogD8N4ekSrkwGNgQJ+/AxP6TNtHTppJSvU8qus6AL4A58JY4ebAFeB4RACSYv3AWZ33AOhRb2kFSZpXKQOG1KxuI5QozwMB2CK3AM+V+gTwFVgLrFErbgLvNPwvdIQsN3RdfGAYGA5bfTEAs0CbptgwMAH8UH9YDXwGPqoIbQV2aoUMGKH6rO/bLPZkALgZBsBL/xcHwBPVfBn6IWBfgP0uLcUF/c0AuKbr4ohQGACJtIRfROYj8ELzbqOK0F7gosMANyzFJe3XgPMRXDAMgNjvLOC3iqe0W6Ra8kFfN2JFpBoY1YDUaGfURlBepAQlDMBH4Jpmh7RlH9QMJBWlwUgzYgGxOmNfbNmKAiC98gv1gQ/qgnKKkZRm6Xq9TmlCpIo9tLJBAPwOk0O3fdD/TcB7P3l4QHRIrsseAAAAAElFTSuQmCC">

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>

    <style>
        /* --- Reset e Estilos Base --- */
        html,
        body {
            margin: 0;
            padding: 0;
            border: 0;
            width: 100%;
            min-height: 100%;
            overflow-x: hidden;
        }

        body.sidebar-is-open,
        body.modal-open {
            overflow: hidden;
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, hsl(222, 84%, 4%) 0%, hsl(217, 32%, 17%) 100%);
            color: hsl(210, 40%, 98%);
            min-height: 100vh;
            line-height: 1.6;
        }

        /* --- Variáveis de Cor e Estilo (Tema) --- */
        :root {
            --background: hsl(222, 84%, 4%);
            --foreground: hsl(210, 40%, 98%);
            --card: hsl(222, 84%, 4%);
            --card-foreground: hsl(210, 40%, 98%);
            --primary: hsl(43, 96%, 56%);
            /* Dourado/Amarelo */
            --primary-foreground: hsl(222, 84%, 4%);
            --secondary: hsl(217, 32%, 17%);
            --secondary-foreground: hsl(210, 40%, 98%);
            --muted: hsl(217, 32%, 17%);
            --muted-foreground: hsl(215, 20%, 65%);
            --accent: hsl(43, 96%, 56%);
            --accent-foreground: hsl(222, 84%, 4%);
            --destructive: hsl(0, 84%, 60%);
            /* Vermelho para ações de exclusão */
            --border: hsl(217, 32%, 25%);
            --input: hsl(217, 32%, 22%);
            --radius: 0.75rem;
            /* Arredondamento das bordas */
            --color-green: #22c55e;
            --color-blue: #3b82f6;
            --color-inprogress: #8b5cf6;
        }

        /* --- Classes Utilitárias --- */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 1rem;
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: var(--radius);
            padding: 1.5rem;
        }

        .text-green {
            color: var(--color-green);
        }

        .text-red {
            color: var(--destructive);
        }

        .empty-state {
            text-align: center;
            padding: 2rem;
            color: var(--muted-foreground);
        }

        /* --- Barra de Navegação Superior (Cliente) --- */
        .navbar {
            display: flex;
            margin: 1rem;
            padding: 1rem;
            position: sticky;
            top: 1rem;
            z-index: 100;
        }

        .nav-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 1rem;
            width: 100%;
        }

        .nav-brand {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .logo {
            width: 2.5rem;
            height: 2.5rem;
            background: var(--primary);
            border-radius: var(--radius);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
        }

        .nav-brand h1 {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--accent);
        }

        .nav-buttons {
            display: flex;
            gap: 0.5rem;
        }

        .nav-btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: var(--radius);
            background: var(--secondary);
            color: var(--secondary-foreground);
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .nav-btn.active,
        .nav-btn:hover {
            background: var(--primary);
            color: var(--primary-foreground);
        }

        /* --- Estrutura das Seções da Página --- */
        .page-section {
            display: none;
            padding: 1rem 0;
            animation: fadeIn .4s ease;
        }

        #clientArea {
            display: block;
        }

        .section-title {
            font-size: 2rem;
            color: var(--accent);
            text-align: center;
            margin-bottom: 2rem;
        }

        /* --- Formulários --- */
        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            background: var(--input);
            color: var(--foreground);
            font-size: 1rem;
        }

        .form-control-small {
            padding: .5rem .75rem;
            font-size: .875rem;
        }

        /* --- Botões --- */
        .btn-primary {
            background: var(--primary);
            color: var(--primary-foreground);
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: var(--radius);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: auto;
            font-size: 1rem;
            text-align: center;
        }

        .btn-secondary {
            background: var(--secondary);
            color: var(--secondary-foreground);
            border: 1px solid var(--border);
            padding: 0.75rem 1.5rem;
            border-radius: var(--radius);
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1rem;
            text-align: center;
        }

        .btn-danger {
            background: var(--destructive);
            color: var(--foreground);
            border: none;
        }

        .btn-small {
            padding: .5rem 1rem;
            font-size: .875rem;
            width: auto;
        }

        .btn-icon {
            background: none;
            border: none;
            color: var(--foreground);
            cursor: pointer;
            font-size: 1.2rem;
            padding: 0.5rem;
        }

        .btn-primary-outline {
            background: transparent;
            color: var(--primary);
            border: 2px solid var(--primary);
            padding: 0.5rem 1rem;
            font-size: 0.9rem;
            font-weight: 600;
            border-radius: var(--radius);
            cursor: pointer;
            transition: all .3s ease;
        }

        .btn-primary-outline:hover {
            background: var(--primary);
            color: var(--primary-foreground);
        }

        .btn-primary-outline i {
            margin-right: 0.5rem;
        }

        /* --- Layout do Dashboard --- */
        .dashboard-layout {
            padding: 0;
        }

        .dashboard-main {
            margin-left: 280px;
            padding: 1.5rem;
            transition: margin-left .3s ease;
        }

        #sidebarToggle {
            display: none;
            position: fixed;
            top: 1.5rem;
            left: 1.5rem;
            z-index: 1050;
            background-color: var(--secondary);
            border-radius: var(--radius);
            width: 40px;
            height: 40px;
            align-items: center;
            justify-content: center;
            border: 1px solid var(--border);
        }

        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            gap: 1rem;
        }

        .dashboard-header-actions {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .dashboard-header h2 {
            font-size: 1.875rem;
            font-weight: 700;
            margin: 0;
        }

        .dashboard-header p {
            color: var(--muted-foreground);
            margin: 0;
        }

        /* --- Barra Lateral (Sidebar) do Dashboard --- */
        .dashboard-sidebar {
            width: 280px;
            height: 100vh;
            position: fixed;
            top: 0;
            left: 0;
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            z-index: 1100;
            transition: left .3s ease;
            border-right: 1px solid var(--border);
            background: var(--background);
        }

        .sidebar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        .sidebar-brand h2 {
            font-size: 1.25rem;
            color: var(--accent);
        }

        #closeSidebarBtn {
            display: none;
        }

        .sidebar-nav {
            display: flex;
            flex-direction: column;
            gap: .25rem;
            flex-grow: 1;
            overflow-y: auto;
        }

        .sidebar-footer {
            margin-top: auto;
            padding-top: 1rem;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            flex-shrink: 0;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: .75rem 1rem;
            border-radius: var(--radius);
            cursor: pointer;
            transition: all .2s ease;
            width: 100%;
            text-decoration: none;
            color: var(--foreground);
            font-size: .95rem;
            white-space: nowrap;
        }

        .nav-item:hover {
            background: rgba(255, 255, 255, .05);
        }

        .nav-item.active {
            background: var(--accent);
            color: var(--primary-foreground);
            font-weight: 600;
        }

        .nav-item.active .nav-icon {
            color: var(--primary-foreground);
        }

        .nav-item.parent-active {
            background: rgba(255, 255, 255, .05);
            color: var(--foreground);
        }

        .nav-icon {
            font-size: 1rem;
            width: 1.25rem;
            text-align: center;
            color: var(--muted-foreground);
        }

        .nav-arrow {
            margin-left: auto;
            transition: transform .3s ease;
        }

        .nav-group.open>.nav-parent .nav-arrow {
            transform: rotate(90deg);
        }

        .nav-submenu {
            max-height: 0;
            overflow: hidden;
            transition: max-height .3s ease-out;
        }

        .nav-submenu .nav-item {
            padding-left: 3rem;
        }

        .sidebar-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1090;
        }

        /* --- Conteúdo Principal do Dashboard --- */
        .content-view {
            display: none;
        }

        .dashboard-grid-modern {
            display: grid;
            gap: 1.5rem;
            grid-template-columns: repeat(5, 1fr);
        }

        .card-grid-span-2 {
            grid-column: span 2;
        }

        .card-grid-span-5 {
            grid-column: span 5;
        }

        .welcome-card {
            background: var(--secondary);
            padding: 2rem;
        }

        .stat-card-modern {
            background: var(--secondary);
            padding: 1.5rem;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .list-card {
            background-color: var(--secondary);
            padding: 1.5rem;
        }

        .section-header {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            gap: 1rem;
        }

        .section-header h3 {
            font-size: 1.25rem;
            font-weight: 700;
            margin: 0;
        }

        .appointments-list {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .appointment-card {
            background: var(--background);
            padding: 1rem;
            border-radius: var(--radius);
            border: 1px solid var(--border);
            cursor: pointer;
            transition: background-color .2s;
        }

        .appointment-card:hover {
            background-color: var(--secondary);
        }

        .appointment-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: .5rem;
        }

        .appointment-status {
            display: inline-block;
            padding: .25rem .5rem;
            border-radius: .375rem;
            font-size: .75rem;
            font-weight: 500;
            margin-top: .25rem;
            text-transform: capitalize;
        }

        .status-scheduled {
            background: rgba(59, 130, 246, .2);
            color: var(--color-blue);
        }

        .status-completed {
            background: rgba(34, 197, 94, .2);
            color: var(--color-green);
        }

        .status-cancelled {
            background: rgba(239, 68, 68, .2);
            color: #ef4444;
        }

        .status-in_progress {
            background: rgba(139, 92, 246, .2);
            color: var(--color-inprogress);
        }

        .appointment-footer {
            border-top: 1px solid var(--border);
            margin-top: .75rem;
            padding-top: .75rem;
        }

        .caixa-status-indicator {
            padding: .5rem 1rem;
            border-radius: var(--radius);
            font-weight: 600;
            font-size: .9rem;
        }

        .caixa-status-indicator.aberto {
            background-color: var(--color-green);
            color: var(--primary-foreground);
        }

        .caixa-status-indicator.fechado {
            background-color: var(--destructive);
            color: var(--foreground);
        }

        /* --- Visualização da Agenda --- */
        .agenda-nav {
            display: flex;
            gap: .5rem;
            align-items: center;
            flex-wrap: wrap;
        }

        .agenda-view-container {
            display: grid;
            grid-template-columns: 60px 1fr;
            margin-top: 1.5rem;
            overflow-x: auto;
            position: relative;
        }

        .agenda-time-column {
            padding-top: 2.5rem;
        }

        .agenda-time-slot {
            height: 20px;
            display: flex;
            align-items: flex-start;
            justify-content: center;
            font-size: .75rem;
            color: var(--muted-foreground);
            position: relative;
        }

        .agenda-time-slot b {
            position: relative;
            top: -0.6em;
            background: var(--background);
            padding: 0 5px;
            font-weight: 600;
            color: var(--foreground);
        }

        .agenda-time-slot:nth-child(4n+1)::after {
            content: '';
            position: absolute;
            top: 0;
            left: 10%;
            right: 0;
            border-top: 1px solid var(--border);
        }

        .agenda-barbers-area {
            display: grid;
        }

        .agenda-barber-column {
            border-left: 1px solid var(--border);
        }

        .agenda-slots-container {
            position: relative;
        }

        .agenda-barber-header {
            text-align: center;
            padding: .5rem;
            position: sticky;
            top: 0;
            background: var(--background);
            z-index: 10;
            border-bottom: 1px solid var(--accent);
            font-weight: 600;
        }

        .agenda-appointment-block {
            position: absolute;
            left: 6px;
            right: 6px;
            border-radius: 4px;
            cursor: pointer;
            transition: all .2s;
            z-index: 5;
            display: flex;
            flex-direction: column;
            justify-content: center;
            overflow: hidden;
            padding: 5px 10px;
            min-height: 20px;
            border: 1px solid rgba(0, 0, 0, 0.3);
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.2);
        }

        .agenda-appointment-block:hover {
            transform: scale(1.02);
            z-index: 6;
        }

        .agenda-appointment-block.status-scheduled {
            background: linear-gradient(145deg, rgba(59, 130, 246, 0.8), rgba(59, 130, 246, 0.9));
            border-left: 4px solid #3b82f6;
        }

        .agenda-appointment-block.status-in_progress {
            background: linear-gradient(145deg, rgba(139, 92, 246, 0.8), rgba(139, 92, 246, 0.9));
            border-left: 4px solid #8b5cf6;
        }

        .agenda-appointment-block.status-completed {
            background: linear-gradient(145deg, rgba(34, 197, 94, 0.8), rgba(34, 197, 94, 0.9));
            border-left: 4px solid #22c55e;
        }

        .appointment-block-name,
        .appointment-block-service {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            display: block;
            width: 100%;
            line-height: 1.4;
        }

        .appointment-block-name {
            font-weight: 600;
            font-size: 0.8rem;
            color: hsl(210, 40%, 98%);
        }

        .appointment-block-service {
            font-size: 0.75rem;
            color: hsl(210, 40%, 90%);
        }

        /* --- Listas de Dados (Clientes, Serviços, etc.) --- */
        .data-card {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            align-items: center;
            background-color: var(--background);
            padding: 1rem;
            border-radius: var(--radius);
            border-left: 4px solid var(--border);
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .data-card-info {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            font-size: 0.85rem;
            color: var(--muted-foreground);
        }

        .data-card-actions {
            display: flex;
            gap: 0.5rem;
        }

        /* --- Visualização Financeira (Caixa) --- */
        .financial-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
        }

        .summary-item {
            background: var(--background);
            padding: 1rem;
            border-radius: var(--radius);
        }

        .summary-item p {
            margin: 0 0 0.5rem 0;
            color: var(--muted-foreground);
            font-size: 0.9rem;
        }

        .summary-item h4 {
            margin: 0;
            font-size: 1.25rem;
        }

        .summary-item.total h4 {
            color: var(--accent);
        }

        /* --- Seção de Relatórios e Gráficos --- */
        .charts-grid {
            display: grid;
            gap: 1.5rem;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            margin-top: 1.5rem;
        }

        .chart-wrapper {
            position: relative;
            height: 280px;
            width: 100%;
        }

        /* --- Estilos dos Modais e Notificações --- */
        .modal-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, .7);
            backdrop-filter: blur(5px);
            z-index: 2000;
            display: none;
            justify-content: center;
            align-items: center;
            padding: 1rem;
            animation: fadeIn .3s ease;
        }

        .modal-container {
            max-width: 500px;
            width: 100%;
            animation: slideIn .3s ease;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--border);
        }

        .modal-content {
            padding: 1.5rem;
            overflow-y: auto;
        }

        .modal-footer {
            padding: 1rem 1.5rem;
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 0.75rem;
            flex-shrink: 0;
        }

        .modal-footer-actions {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-left: auto;
        }

        .close-modal-btn {
            background: none;
            border: none;
            font-size: 2rem;
            color: var(--muted-foreground);
            cursor: pointer;
            line-height: 1;
            padding: 0;
        }

        #notificationContainer {
            position: fixed;
            bottom: 1.5rem;
            right: 1.5rem;
            z-index: 2100;
            display: flex;
            flex-direction: column;
            gap: .75rem;
        }

        .notification {
            padding: 1rem 1.5rem;
            border-radius: var(--radius);
            color: var(--primary-foreground);
            min-width: 250px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, .2);
            animation: slideInUp .4s ease;
            opacity: 1;
            transition: opacity 0.5s ease;
        }

        .notification.success {
            background-color: hsl(142, 76%, 36%);
        }

        .notification.error {
            background-color: var(--destructive);
        }

        /* --- Animações --- */
        @keyframes fadeIn {
            from {
                opacity: 0
            }

            to {
                opacity: 1
            }
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-20px)
            }

            to {
                opacity: 1;
                transform: translateY(0)
            }
        }

        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(20px)
            }

            to {
                opacity: 1;
                transform: translateY(0)
            }
        }

        /* --- Estilos da Área do Cliente --- */
        .barbers-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1.5rem;
        }

        .booking-form-container {
            margin-top: 3rem;
        }

        .booking-form {
            max-width: 600px;
            margin: 2rem auto;
        }

        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 80vh;
        }

        .login-form {
            max-width: 400px;
            width: 100%;
        }

        /* --- Responsividade --- */
        @media (max-width: 1024px) {
            .dashboard-main {
                margin-left: 0;
                padding: 1rem;
                padding-top: 5rem;
            }

            #sidebarToggle {
                display: inline-flex;
            }

            .dashboard-sidebar {
                left: -290px;
            }

            body.sidebar-is-open .dashboard-sidebar {
                left: 0;
            }

            body.sidebar-is-open .sidebar-overlay {
                display: block;
            }

            #closeSidebarBtn {
                display: block;
            }

            .dashboard-grid-modern {
                grid-template-columns: 1fr;
            }

            .card-grid-span-2,
            .card-grid-span-5 {
                grid-column: span 1;
            }
        }

        @media (max-width: 768px) {
            body {
                font-size: 15px;
            }

            .nav-container {
                flex-direction: column;
                gap: 1rem;
            }

            .dashboard-header {
                flex-direction: column;
                align-items: flex-start;
            }

            .dashboard-header-actions {
                width: 100%;
                justify-content: space-between;
            }

            .glass-card {
                padding: 1rem;
            }

            .dashboard-header h2 {
                font-size: 1.5rem;
            }

            .section-header {
                flex-direction: column;
                align-items: flex-start;
            }

            .section-header .button-group,
            .section-header .agenda-nav {
                width: 100%;
                justify-content: space-between;
            }

            .data-card-info {
                flex-direction: column;
                gap: 0.25rem;
                align-items: flex-start;
            }
        }

        /* --- [NOVO] Estilos para o Fluxo de Agendamento --- */
        .barber-card-selectable {
            cursor: pointer;
            text-align: center;
            transition: all .2s ease;
            border: 2px solid transparent;
        }

        .barber-card-selectable:hover {
            transform: scale(1.05);
            background-color: var(--secondary);
        }

        .barber-card-selectable.selected {
            border-color: var(--primary);
            background-color: var(--secondary);
        }

        .barber-card-selectable img {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            object-fit: cover;
            margin: 0 auto 1rem;
            border: 3px solid var(--primary);
        }

        .time-slot-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 0.75rem;
        }

        .time-slot-btn {
            background: var(--secondary);
            color: var(--foreground);
            border: 1px solid var(--border);
            padding: 0.75rem 0.5rem;
            text-align: center;
            border-radius: var(--radius);
            cursor: pointer;
            transition: all .2s ease;
        }

        .time-slot-btn:hover:not(:disabled) {
            background: var(--primary);
            color: var(--primary-foreground);
        }

        .time-slot-btn:disabled {
            background: var(--input);
            color: var(--muted-foreground);
            cursor: not-allowed;
            opacity: 0.5;
        }

        .confirmation-summary {
            background: var(--secondary);
            padding: 1rem;
            border-radius: var(--radius);
            margin-bottom: 1.5rem;
        }

        .confirmation-summary p {
            margin: 0.5rem 0;
            display: flex;
            justify-content: space-between;
        }

        .confirmation-summary p span:first-child {
            color: var(--muted-foreground);
        }

        .confirmation-summary p span:last-child {
            font-weight: 600;
        }

        .confirmation-summary hr {
            border-color: var(--border);
            margin: 1rem 0;
        }

        .confirmation-summary .total {
            font-size: 1.2rem;
            color: var(--primary);
        }

        /* --- [NOVO E ATUALIZADO] Estilos para Header da Loja e Cards de Serviço v2 --- */
        .shop-header {
            padding: 2rem 1rem;
            text-align: center;
            margin-bottom: 2rem;
        }

        .shop-header h2 {
            font-size: 3rem;
            font-weight: 800;
            color: var(--foreground);
            letter-spacing: -1px;
            margin: 0;
        }

        .shop-header .rating {
            color: var(--primary);
            margin: 0.5rem 0;
        }

        .shop-header .address {
            font-size: 1rem;
            color: var(--muted-foreground);
        }

        /* Estilos da Barra de Pesquisa Melhorada */
        .search-bar-wrapper {
            position: relative;
            margin-bottom: 2.5rem;
        }

        .search-bar-wrapper .fa-search {
            position: absolute;
            top: 50%;
            left: 1.25rem;
            transform: translateY(-50%);
            color: var(--muted-foreground);
            transition: color 0.3s ease;
        }

        #serviceSearchInput {
            width: 100%;
            border: 2px solid var(--border);
            background-color: var(--secondary);
            border-radius: 50px;
            /* Deixa com formato de pílula */
            padding: 0.8rem 1rem 0.8rem 3.25rem;
            /* Mais espaçamento interno */
            font-size: 1rem;
            color: var(--foreground);
            transition: all 0.3s ease;
            -webkit-appearance: none;
            /* Remove estilos padrão do iOS */
        }

        #serviceSearchInput::placeholder {
            color: var(--muted-foreground);
        }

        #serviceSearchInput:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 4px hsla(43, 96%, 56%, 0.15);
            /* Efeito de brilho sutil */
        }

        .search-bar-wrapper:focus-within .fa-search {
            color: var(--primary);
            /* Muda a cor do ícone quando focado */
        }

        /* Estilos dos Cards de Serviço (sem alteração) */
        .service-list-v2 {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .service-card-v2 {
            display: flex;
            align-items: center;
            gap: 1.5rem;
            background: var(--secondary);
            padding: 1rem;
            border-radius: var(--radius);
        }

        .service-card-v2 .service-image {
            width: 64px;
            height: 64px;
            border-radius: var(--radius);
            object-fit: cover;
        }

        .service-card-v2 .service-details {
            flex-grow: 1;
        }

        .service-card-v2 h4 {
            margin: 0;
            font-size: 1.1rem;
            color: var(--foreground);
        }

        .service-card-v2 .sub-details {
            color: var(--muted-foreground);
            font-size: 0.9rem;
        }

        .service-card-v2 .btn-primary {
            padding: 0.5rem 1rem;
            font-size: 0.9rem;
        }
    </style>
</head>
<body>
    <nav class="navbar glass-card">
        <div class="nav-container">
            <div class="nav-brand">
                <div class="logo">SB</div>
                <h1>Steves Barbearia</h1>
            </div>
            <div class="nav-buttons">
                <button class="nav-btn active" id="clientAreaBtn">Área do Cliente</button>
            </div>
        </div>
    </nav>

    <div id="clientArea" class="page-section">
        <div class="container">
            <div id="clientServicesSection">
                <div class="shop-header">
                    <h2>STEVE'S BARBEARIA</h2>
                    <div class="rating">
                        <i class="fas fa-star"></i>
                        <i class="fas fa-star"></i>
                        <i class="fas fa-star"></i>
                        <i class="fas fa-star"></i>
                        <i class="fas fa-star"></i>
                        <span style="color: var(--muted-foreground); margin-left: 0.5rem;">5.0</span>
                    </div>
                    <p class="address"><i class="fas fa-map-marker-alt"></i> Rua dos Ipês, 18 - Jardim Novo Horizonte - Rolândia/PR</p>
                </div>

                <div class="search-bar-wrapper">
                    <i class="fas fa-search"></i>
                    <input type="search" id="serviceSearchInput" placeholder="Pesquisar serviço..." class="form-group input">
                </div>

                <div id="clientServicesList" class="service-list-v2">
                </div>
            </div>

            <div id="bookingFlowContainer" class="booking-form-container" style="display: none;">
                <div class="glass-card booking-form">
                    <button id="backToServicesBtn" class="btn-icon" style="position: absolute; top: 1.5rem; left: 1.5rem; font-size: 1.5rem;">&lt;</button>

                    <div id="step1_Professionals" class="booking-step">
                        <h3 class="section-title">Selecione o Profissional</h3>
                        <div id="professionalsListContainer" class="barbers-grid">
                        </div>
                    </div>

                    <div id="step2_DateTime" class="booking-step" style="display: none;">
                        <h3 class="section-title">Escolha a Data e o Horário</h3>
                        <div class="form-group">
                            <label for="bookingDate">Data</label>
                            <input type="date" id="bookingDate" class="form-control">
                        </div>
                        <h4 style="margin-top: 2rem; margin-bottom: 1rem;">Horários disponíveis</h4>
                        <div id="availableTimesContainer" class="time-slot-grid">
                        </div>
                    </div>

                    <div id="step3_Confirmation" class="booking-step" style="display: none;">
                        <h3 class="section-title">Confirme seu Agendamento</h3>
                        <div id="confirmationSummary" class="confirmation-summary">
                        </div>
                        <form id="clientDetailsForm">
                            <div class="form-group"><label for="finalClientName">Seu Nome Completo</label><input type="text" id="finalClientName" required></div>
                            <div class="form-group"><label for="finalClientPhone">Seu Celular (com DDD)</label><input type="tel" id="finalClientPhone" placeholder="43999999999" required></div>
                            <div class="form-group">
                                <label for="observations">Alguma observação?</label>
                                <textarea id="observations" rows="2" placeholder="Ex: Não precisa lavar, etc..."></textarea>
                            </div>
                            <button type="submit" class="btn-primary" style="width: 100%;">Confirmar Agendamento</button>
                        </form>
                    </div>

                </div>
            </div>
        </div>
        <footer class="site-footer" style="text-align: center; padding: 2rem 0; margin-top: 2rem; border-top: 1px solid var(--border);">
            <p style="margin: 0; font-size: 0.9rem;">
                <button id="barberAreaBtn" style="background:none;border:none;color:var(--muted-foreground);text-decoration:underline;cursor:pointer;font-size:0.9rem;padding:0;">Login do Barbeiro</button>
            </p>
            <p style="margin: 0.5rem 0 0 0; font-size: 0.8rem; color: var(--muted-foreground);">© 2025 Steves Barbearia. Todos os direitos reservados.</p>
        </footer>
    </div>

    <div id="barberLogin" class="page-section">
        <div class="container">
            <div class="login-container">
                <div class="glass-card login-form">
                    <div class="login-header">
                        <h2>Acesso do Barbeiro</h2>
                        <p>Entre com suas credenciais</p>
                    </div>
                    <form id="loginForm">
                        <div class="form-group"><label for="username">Usuário</label><input type="text" id="username" value="barbeiro" required autocomplete="username"></div>
                        <div class="form-group"><label for="password">Senha</label><input type="password" id="password" value="123" required autocomplete="current-password"></div>
                        <button type="submit" class="btn-primary">Entrar</button>
                        <button type="button" class="btn-secondary" id="demoLoginBtn" style="margin-top:0.5rem;">Entrar como demonstração</button>
                    </form>
                    <p class="demo-info">Demo: usuário "barbeiro" senha "123"</p>
                </div>
            </div>
        </div>
    </div>

    <div id="barberDashboard" class="page-section">
        <div class="dashboard-layout">
            <aside class="dashboard-sidebar">
                <div class="sidebar-header">
                    <div class="nav-brand">
                        <div class="logo">SB</div>
                        <h2>Steves Barbearia</h2>
                    </div>
                    <button id="closeSidebarBtn" class="btn-icon" aria-label="Fechar menu"><i class="fas fa-times"></i></button>
                </div>
                <nav class="sidebar-nav">
                    <a class="nav-item" data-view="dashboardView"><i class="nav-icon fas fa-chart-bar"></i><span>Dashboard</span></a>
                    <a class="nav-item" data-view="appointmentsView"><i class="nav-icon fas fa-calendar-alt"></i><span>Agenda</span></a>
                    <a class="nav-item" data-view="comandasView"><i class="nav-icon fas fa-receipt"></i><span>Comandas Abertas</span></a>

                    <div class="nav-group">
                        <a class="nav-item nav-parent">
                            <i class="nav-icon fas fa-edit"></i>
                            <span>Cadastros</span>
                            <i class="nav-arrow fas fa-chevron-right"></i>
                        </a>
                        <div class="nav-submenu">
                            <a class="nav-item" data-view="clientsView"><i class="nav-icon fas fa-users"></i><span>Clientes</span></a>
                            <a class="nav-item" data-view="servicesView"><i class="nav-icon fas fa-cut"></i><span>Serviços</span></a>
                            <a class="nav-item" data-view="professionalsView"><i class="nav-icon fas fa-store"></i><span>Profissionais</span></a>
                        </div>
                    </div>

                    <div class="nav-group">
                        <a class="nav-item nav-parent">
                            <i class="nav-icon fas fa-dollar-sign"></i>
                            <span>Financeiro</span>
                            <i class="nav-arrow fas fa-chevron-right"></i>
                        </a>
                        <div class="nav-submenu">
                            <a class="nav-item" data-view="financialView"><i class="nav-icon fas fa-cash-register"></i><span>Caixa</span></a>
                            <a class="nav-item" data-view="reportsView"><i class="nav-icon fas fa-chart-pie"></i><span>Relatórios</span></a>
                        </div>
                    </div>
                </nav>
                <div class="sidebar-footer">
                    <button class="btn-secondary" id="logoutBtnSidebar"><i class="fas fa-door-open"></i> Sair</button>
                    <button class="btn-secondary btn-danger" id="resetDataBtn"><i class="fas fa-trash"></i> Resetar Dados (Teste)</button>
                </div>
            </aside>
            <div id="sidebarOverlay" class="sidebar-overlay"></div>

            <main class="dashboard-main">
                <button id="sidebarToggle" class="btn-icon" aria-label="Abrir menu"><i class="fas fa-bars"></i></button>
                <div class="dashboard-header">
                    <div id="header-info">
                        <h2 id="dashboardTitle">Dashboard</h2>
                        <p id="dashboardSubtitle">Visão geral do seu negócio.</p>
                    </div>
                    <div class="dashboard-header-actions">
                        <div id="caixaStatus" class="caixa-status-indicator"></div>
                        <button class="btn-secondary" id="logoutBtn"><i class="fas fa-door-open"></i> Sair</button>
                    </div>
                </div>

                <div id="dashboardView" class="content-view">
                    <div class="dashboard-grid-modern">
                        <div class="welcome-card card-grid-span-2">
                            <h3>Bem-vindo, Barbeiro!</h3>
                            <p>Aqui está um resumo rápido do seu dia.</p><button class="btn-primary-outline" id="quickAddAppointmentBtn"><i class="fas fa-plus"></i> Novo Agendamento</button><button class="btn-primary" id="welcomeOpenCaixaBtn" style="display: none; margin-left: 0.5rem;"><i class="fas fa-cash-register"></i> Abrir Caixa</button>
                        </div>
                        <div class="stat-card-modern">
                            <div class="stat-info-modern">
                                <p>Faturamento Hoje</p>
                                <h3 id="todayProfit">R$ 0,00</h3>
                            </div>
                        </div>
                        <div class="stat-card-modern">
                            <div class="stat-info-modern">
                                <p>Agendamentos Hoje</p>
                                <h3 id="todayCount">0</h3>
                            </div>
                        </div>
                        <div class="stat-card-modern">
                            <div class="stat-info-modern">
                                <p>Comandas em Aberto</p>
                                <h3 id="pendingCount">0</h3>
                            </div>
                        </div>
                        <div class="list-card card-grid-span-5">
                            <div class="section-header">
                                <h3>Próximos Agendamentos</h3><button class="btn-secondary btn-small" id="refreshBtn"><i class="fas fa-sync-alt"></i> Atualizar</button>
                            </div>
                            <div id="appointmentsList" class="appointments-list"></div>
                        </div>
                    </div>
                </div>

                <div id="appointmentsView" class="content-view">
                    <div class="glass-card">
                        <div class="section-header">
                            <div class="agenda-nav"><button id="prevDayBtn" class="btn-secondary btn-small">⟨ Anterior</button><input type="date" id="agendaDateFilter" class="form-control-small"><button id="nextDayBtn" class="btn-secondary btn-small">Próximo ⟩</button></div><button id="addAppointmentBtn" class="btn-primary">Novo Agendamento</button>
                        </div>
                        <div id="agendaViewContainer" class="agenda-view-container"></div>
                    </div>
                </div>

                <div id="comandasView" class="content-view">
                    <div class="glass-card">
                        <div class="section-header">
                            <h3>Comandas em Aberto</h3><button id="addWalkInBtn" class="btn-primary">Novo Atendimento (Encaixe)</button>
                        </div>
                        <div id="pendingAppointmentsList" class="appointments-list"></div>
                    </div>
                </div>

                <div id="clientsView" class="content-view">
                    <div class="glass-card">
                        <div class="section-header">
                            <h3>Gestão de Clientes</h3><input type="search" id="clientSearchInput" placeholder="Buscar por nome ou telefone..." class="form-control-small">
                        </div>
                        <div id="fullClientsList" class="clients-list" style="margin-top:1rem;"></div>
                    </div>
                </div>

                <div id="servicesView" class="content-view">
                    <div class="glass-card">
                        <div class="section-header">
                            <h3>Serviços Oferecidos</h3><button id="addServiceBtn" class="btn-primary">Adicionar Serviço</button>
                        </div>
                        <div id="servicesList" style="margin-top:1rem;"></div>
                    </div>
                </div>

                <div id="professionalsView" class="content-view">
                    <div class="glass-card">
                        <div class="section-header">
                            <h3>Profissionais</h3><button id="addProfessionalBtn" class="btn-primary">Adicionar Profissional</button>
                        </div>
                        <div id="professionalsList" style="margin-top:1rem;"></div>
                    </div>
                </div>

                <div id="financialView" class="content-view">
                    <div class="glass-card">
                        <div class="section-header">
                            <h3>Controle de Caixa</h3>
                            <div class="button-group"><button id="viewHistoryBtn" class="btn-secondary btn-small">Ver Histórico</button><button id="addExpenseBtnMain" class="btn-secondary btn-small">Adicionar Despesa</button><button id="openCaixaBtn" class="btn-primary">Abrir Caixa</button><button id="closeCaixaBtn" class="btn-secondary btn-danger">Fechar Caixa</button></div>
                        </div>
                        <div id="financialDashboard"></div>
                    </div>
                </div>

                <div id="reportsView" class="content-view">
                    <div class="charts-grid">
                        <div class="glass-card chart-container">
                            <div class="chart-header">
                                <h4>Faturamento dos Últimos 7 Dias</h4>
                            </div>
                            <div class="chart-wrapper"><canvas id="revenueChart"></canvas></div>
                        </div>
                        <div class="glass-card chart-container">
                            <div class="chart-header">
                                <h4>Serviços Mais Realizados</h4>
                            </div>
                            <div class="chart-wrapper"><canvas id="servicesChart"></canvas></div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <div id="modalBackdrop" class="modal-backdrop">
        <div id="modalContainer" class="modal-container glass-card">
            <div class="modal-header">
                <h3 id="modalTitle"></h3>
                <button id="closeModalBtn" class="close-modal-btn">&times;</button>
            </div>
            <div id="modalContent" class="modal-content"></div>
        </div>
    </div>

    <div id="notificationContainer"></div>


    <script>
        class BarberPro {
            constructor() {
                this.bookingState = {};
                this.currentUser = null;
                this.charts = {};
                this.DATA_VERSION = '6.6';
                document.addEventListener('DOMContentLoaded', () => this.init());
            }

            init() {
                try {
                    this.checkDataVersion();
                    this.setupGlobalEventListeners();
                    this.loadData();

                    const token = this.getFromStorage('auth_token', null);
                    if (token) {
                        this.currentUser = token;
                        this.renderBarberView();
                    } else {
                        this.renderClientView();
                    }
                } catch (error) {
                    console.error('Erro crítico durante a inicialização:', error);
                    this.showNotification('Ocorreu um erro crítico. O sistema não pôde ser carregado.', 'error');
                }
            }

            renderClientView() {
                this.showSection('clientArea');
                this.resetBookingFlow();

                const searchTerm = document.getElementById('serviceSearchInput')?.value.toLowerCase() || '';
                const container = document.getElementById('clientServicesList');

                if (container) {
                    const filteredServices = this.services.filter(service =>
                        service.name.toLowerCase().includes(searchTerm)
                    );

                    if (filteredServices.length > 0) {
                        container.innerHTML = filteredServices.map(service => `
                            <div class="service-card-v2">
                                <img src="${service.imageUrl || 'https://via.placeholder.com/64x64.png/c7a355/222831?text=S'}" alt="${service.name}" class="service-image">
                                <div class="service-details">
                                    <h4>${service.name}</h4>
                                    <div class="sub-details">
                                        <span>${this.formatCurrency(service.price)}</span> &bull; <span>${service.duration} min</span>
                                    </div>
                                </div>
                                <button class="btn-primary" onclick="window.barberPro.startBooking('${service.id}')">Agendar</button>
                            </div>
                        `).join('');
                    } else {
                        container.innerHTML = '<p class="empty-state">Nenhum serviço encontrado.</p>';
                    }
                }
            }

            renderBarberView() {
                this.showSection('barberDashboard');
                const agendaDateFilter = document.getElementById('agendaDateFilter');
                if (agendaDateFilter && !agendaDateFilter.value) {
                    agendaDateFilter.value = this.getTodayDateString();
                }
                this.switchDashboardView('dashboardView');
            }

            setupGlobalEventListeners() {
                document.body.addEventListener('click', e => {
                    const actionTarget = e.target.closest('[data-action]');
                    if (actionTarget) {
                        e.preventDefault();
                        this.handleActionClick(actionTarget.dataset.action, actionTarget.dataset.id);
                        return;
                    }
                    const buttonTarget = e.target.closest('button');
                    if (buttonTarget) {
                        const buttonId = buttonTarget.id;
                        switch (buttonId) {
                            case 'backToServicesBtn': this.resetBookingFlow(); break;
                            case 'sidebarToggle':
                            case 'closeSidebarBtn': document.body.classList.toggle('sidebar-is-open'); break;
                            case 'clientAreaBtn': this.renderClientView(); break;
                            case 'barberAreaBtn': this.checkAuthentication(); break;
                            case 'demoLoginBtn': this.login('barbeiro', '123'); break;
                            case 'logoutBtn':
                            case 'logoutBtnSidebar': this.logout(); break;
                            case 'refreshBtn': this.loadDashboardData(); this.showNotification('Dados atualizados!'); break;
                            case 'resetDataBtn': this.resetTestData(); break;
                            case 'prevDayBtn': this.navigateAgendaDays(-1); break;
                            case 'nextDayBtn': this.navigateAgendaDays(1); break;
                            case 'addServiceBtn': this.showServiceModal(); break;
                            case 'addProfessionalBtn': this.showProfessionalModal(); break;
                            case 'addAppointmentBtn': this.showAppointmentModal(true); break;
                            case 'quickAddAppointmentBtn': this.showAppointmentModal(true); break;
                            case 'addWalkInBtn': this.showAppointmentModal(false); break;
                            case 'welcomeOpenCaixaBtn': this.showAbrirCaixaModal(); break;
                            case 'openCaixaBtn': this.showAbrirCaixaModal(); break;
                            case 'closeCaixaBtn': this.showFecharCaixaModal(); break;
                            case 'viewHistoryBtn': this.showCaixaHistoryModal(); break;
                            case 'addExpenseBtnMain': this.showExpenseModal(); break;
                            case 'closeModalBtn': this.hideModal(); break;
                        }
                    }
                    const navItem = e.target.closest('.sidebar-nav .nav-item:not(.nav-parent)');
                    if (navItem) {
                        e.preventDefault();
                        this.switchDashboardView(navItem.dataset.view);
                    }
                    const navParent = e.target.closest('.nav-parent');
                    if (navParent) {
                        e.preventDefault();
                        const parentGroup = navParent.closest('.nav-group');
                        if (!parentGroup) return;
                        const submenu = parentGroup.querySelector('.nav-submenu');
                        if (!submenu) return;
                        parentGroup.classList.toggle('open');
                        submenu.style.maxHeight = parentGroup.classList.contains('open') ? submenu.scrollHeight + "px" : null;
                    }
                });

                document.body.addEventListener('submit', e => {
                    e.preventDefault();
                    const form = e.target;
                    const submitButton = document.querySelector(`button[type="submit"][form="${form.id}"]`) || form.querySelector('button[type="submit"]');
                    if (submitButton) {
                        submitButton.disabled = true;
                        setTimeout(() => { submitButton.disabled = false; }, 1000);
                    }

                    switch (form.id) {
                        case 'clientDetailsForm': this.handleClientBookingConfirmation(e); break;
                        case 'barberBookingForm': this.handleAppointmentSubmit(new FormData(form), form.dataset.walkIn === 'true'); break;
                        case 'loginForm': this.handleLoginSubmit(form); break;
                        case 'serviceForm': this.saveService(new FormData(form)); break;
                        case 'professionalForm': this.saveProfessional(new FormData(form)); break;
                        case 'expenseForm': this.saveExpense(new FormData(form)); break;
                        case 'openCaixaForm': this.abrirCaixa(this.parseCurrency(new FormData(form).get('initialValue'))); break;
                        case 'closeCaixaForm': this.fecharCaixa(this.parseCurrency(new FormData(form).get('countedCash'))); break;
                    }
                });

                document.body.addEventListener('input', e => {
                    if (e.target.id === 'clientSearchInput') this.renderFullClientsList();
                    if (e.target.matches('#barberBookingForm input[name="name"]')) this.handleClientNameInput(e);
                    if (e.target.id === 'serviceSearchInput') this.renderClientView();
                });

                document.getElementById('sidebarOverlay')?.addEventListener('click', () => document.body.classList.remove('sidebar-is-open'));
                document.getElementById('modalBackdrop')?.addEventListener('click', e => {
                    if (e.target.id === 'modalBackdrop') this.hideModal();
                });
            }
            
            // ... (O restante do seu código JavaScript, a partir da função `resetBookingFlow`, permanece igual até a função `saveService`)
            
            resetBookingFlow(){this.bookingState={},document.getElementById("clientServicesSection").style.display="block",document.getElementById("bookingFlowContainer").style.display="none",document.querySelectorAll(".booking-step").forEach(e=>e.style.display="none"),document.getElementById("step1_Professionals").style.display="block"}showBookingStep(e){document.querySelectorAll(".booking-step").forEach(t=>t.style.display="none"),document.getElementById(`step${e}_${1===e?"Professionals":2===e?"DateTime":"Confirmation"}`).style.display="block"}startBooking(e){const t=this.services.find(t=>t.id===e);t&&(this.bookingState={serviceId:e,serviceName:t.name,servicePrice:t.price,serviceDuration:t.duration},document.getElementById("clientServicesSection").style.display="none",document.getElementById("bookingFlowContainer").style.display="block",document.getElementById("professionalsListContainer").innerHTML=this.barbers.map(e=>`
                    <div class="barber-card-selectable glass-card" onclick="window.barberPro.selectProfessional('${e.id}')">
                        <img src="https://ui-avatars.com/api/?name=${encodeURIComponent(e.name)}&background=c7a355&color=fff&size=128" alt="${e.name}">
                        <h4>${e.name}</h4>
                    </div>
                `).join(""),this.showBookingStep(1))}selectProfessional(e){const t=this.barbers.find(t=>t.id===e);t&&(this.bookingState.barberId=e,this.bookingState.barberName=t.name,this.showBookingStep(2),(()=>{const e=document.getElementById("bookingDate");e.min=this.getTodayDateString(),e.value=this.getTodayDateString(),this.renderAvailableTimes(),e.onchange=()=>this.renderAvailableTimes()})())}renderAvailableTimes(){const e=document.getElementById("bookingDate").value,t=this.bookingState.barberId,o=this.bookingState.serviceDuration,i=document.getElementById("availableTimesContainer");i.innerHTML="<p>Carregando horários...</p>";const n=[],s=new Set;this.appointments.filter(t=>t.barberId===t&&t.date===e&&"cancelled"!==t.status).forEach(e=>{const t=this.services.find(t=>t.id===e.service);if(t){const o=n.indexOf(e.time);if(-1!==o){const e=Math.ceil(t.duration/15);for(let t=0;t<e;t++)n[o+t]&&s.add(n[o+t])}}});let a="";n.forEach((e,t)=>{let r=!0;const l=Math.ceil(o/15);for(let o=0;o<l;o++){const l=n[t+o];if(!l||s.has(l)){r=!1;break}}a+=`<button class="time-slot-btn" onclick="window.barberPro.selectTime('${e}')" ${r?"":"disabled"}>${e}</button>`}),i.innerHTML=a||'<p class="empty-state">Nenhum horário disponível para esta data.</p>'}selectTime(e){this.bookingState.time=e,this.renderConfirmationStep(),this.showBookingStep(3)}renderConfirmationStep(){const{serviceName:e,barberName:t,servicePrice:o,time:i}=this.bookingState,n=document.getElementById("bookingDate").value,s=new Date(`${n}T${i}`);s.setMinutes(s.getMinutes()+this.bookingState.serviceDuration);const a=s.toTimeString().slice(0,5);document.getElementById("confirmationSummary").innerHTML=`
                    <p><span>Serviço</span> <span>${e}</span></p>
                    <p><span>Profissional</span> <span>${t}</span></p>
                    <p><span>Data</span> <span>${this.formatDate(n)}</span></p>
                    <p><span>Horário</span> <span>${i} - ${a} (${this.bookingState.serviceDuration} min)</span></p>
                    <hr>
                    <p class="total"><span>Total</span> <span>${this.formatCurrency(o)}</span></p>
                `}handleClientBookingConfirmation(e){e.preventDefault();const t=document.getElementById("finalClientName").value.trim(),o=document.getElementById("finalClientPhone").value.trim(),i=document.getElementById("bookingDate").value;if(t&&o){const e={id:Date.now().toString(),createdAt:(new Date).toISOString(),name:t,phone:this.sanitizePhone(o),service:this.bookingState.serviceId,barberId:this.bookingState.barberId,date:i,time:this.bookingState.time,status:"scheduled",paymentStatus:"pending"};this.getOrUpdateClient(e.phone,e.name),this.appointments.push(e),this.saveData(),this.showNotification("Agendamento confirmado com sucesso! 🎉","success"),this.resetBookingFlow()}else this.showNotification("Por favor, preencha seu nome e telefone.","error")}handleActionClick(e,t){const o={"open-comanda-modal":()=>this.showComandaActionsModal(t),"cancel-appointment":()=>this.cancelAppointment(t),"edit-service":()=>this.showServiceModal(t),"delete-service":()=>this.deleteService(t),"edit-professional":()=>this.showProfessionalModal(t),"delete-professional":()=>this.deleteProfessional(t),"view-client-details":()=>this.showClientDetailModal(t)};o[e]&&o[e]()}showSection(e){document.querySelectorAll(".page-section").forEach(e=>e.style.display="none"),document.getElementById(e).style.display="block",document.querySelector(".navbar").style.display="barberDashboard"===e?"none":"flex",document.getElementById("clientAreaBtn").classList.toggle("active","clientArea"===e),document.getElementById("barberAreaBtn").classList.toggle("active","barberLogin"===e||"barberDashboard"===e)}switchDashboardView(e){if(!e)return;document.querySelectorAll(".content-view").forEach(e=>e.style.display="none"),document.getElementById(e).style.display="block";const{title:t,subtitle:o}={dashboardView:{title:"Dashboard",subtitle:"Visão geral do seu negócio."},appointmentsView:{title:"Agenda",subtitle:"Visualize e gerencie seus horários."},comandasView:{title:"Comandas Abertas",subtitle:"Gerencie os atendimentos em andamento."},clientsView:{title:"Clientes",subtitle:"Consulte e gerencie sua base de clientes."},servicesView:{title:"Serviços",subtitle:"Configure os serviços oferecidos."},professionalsView:{title:"Profissionais",subtitle:"Gerencie a equipe de barbeiros."},financialView:{title:"Caixa",subtitle:"Acompanhe suas receitas e despesas."},reportsView:{title:"Relatórios",subtitle:"Analise o desempenho da sua barbearia."}}[e]||{title:"Página",subtitle:""};document.getElementById("dashboardTitle").textContent=t,document.getElementById("dashboardSubtitle").textContent=o,document.querySelectorAll(".sidebar-nav .nav-item").forEach(e=>e.classList.remove("active","parent-active"));const i=document.querySelector(`.sidebar-nav .nav-item[data-view="${e}"]`);if(i){i.classList.add("active");const e=i.closest(".nav-group");e&&e.querySelector(".nav-parent")?.classList.add("parent-active")}({dashboardView:this.loadDashboardData,appointmentsView:this.renderAgendaView,comandasView:this.renderPendingAppointments,clientsView:this.renderFullClientsList,servicesView:this.renderServicesList,professionalsView:this.renderProfessionalsList,financialView:this.renderFinancialPage,reportsView:this.renderCharts})[e]?.call(this),document.body.classList.remove("sidebar-is-open")}checkDataVersion(){localStorage.getItem("barberpro_data_version")!==this.DATA_VERSION&&(localStorage.clear(),localStorage.setItem("barberpro_data_version",this.DATA_VERSION))}getFromStorage(e,t){try{const o=localStorage.getItem(`barberpro_${e}`);return o?JSON.parse(o):t}catch(e){return t}}saveToStorage(e,t){try{localStorage.setItem(`barberpro_${e}`,JSON.stringify(t))}catch(t){console.error(`Erro ao salvar dados (chave: ${e}):`,t),this.showNotification("Erro ao salvar os dados.","error")}}loadData(){this.services=this.getFromStorage("services",[{id:"s_1",name:"Corte Degrade",price:42,duration:45,description:"Corte moderno com efeito degradê.",imageUrl:"https://images.unsplash.com/photo-1621605815971-fbc3337f000b?w=80&h=80&fit=crop"},{id:"s_2",name:"Barba",price:32,duration:30,description:"Modelagem e aparo da barba.",imageUrl:"https://images.unsplash.com/photo-1622288432454-20b171d33306?w=80&h=80&fit=crop"},{id:"s_3",name:"Corte Social",price:34,duration:30,description:"Corte clássico na tesoura e máquina.",imageUrl:"https://images.unsplash.com/photo-1599335593362-e67b2a3a5f45?w=80&h=80&fit=crop"},{id:"s_4",name:"Barboterapia",price:45,duration:30,description:"Barba com toalha quente e massagem.",imageUrl:"https://images.unsplash.com/photo-1532710093739-942318a17684?w=80&h=80&fit=crop"}]),this.barbers=this.getFromStorage("barbers",[{id:"b_1",name:"Hernani",specialty:"Corte e Barba"},{id:"b_2",name:"Fernandinho",specialty:"Degradê"}]),this.appointments=this.getFromStorage("appointments",[]),this.clients=this.getFromStorage("clients",[]),this.caixa=this.getFromStorage("caixa",{status:"fechado",saldoInicial:0,abertura:null,entradas:[],saidas:[]}),this.caixaHistory=this.getFromStorage("caixaHistory",[])}saveData(){this.saveToStorage("services",this.services),this.saveToStorage("barbers",this.barbers),this.saveToStorage("appointments",this.appointments),this.saveToStorage("clients",this.clients),this.saveToStorage("caixa",this.caixa),this.saveToStorage("caixaHistory",this.caixaHistory)}resetTestData(){confirm("ATENÇÃO!\nIsto irá apagar TODOS os dados (agendamentos, clientes, caixa, etc).\nDeseja continuar?")&&(this.appointments=[],this.clients=[],this.caixa={status:"fechado",saldoInicial:0,abertura:null,entradas:[],saidas:[]},this.caixaHistory=[],localStorage.removeItem("barberpro_services"),localStorage.removeItem("barberpro_barbers"),this.saveData(),this.loadData(),this.renderBarberView(),this.showNotification("Dados de teste foram zerados.","success"))}checkAuthentication(){const e=this.getFromStorage("auth_token",null);e?(this.currentUser=e,this.renderBarberView()):this.showSection("barberLogin")}login(e,t){return"barbeiro"===e&&"123"===t?(this.currentUser={username:"barbeiro"},this.saveToStorage("auth_token",this.currentUser),this.renderBarberView(),this.showNotification("Login realizado com sucesso!","success"),!0):!1}logout(){this.currentUser=null,localStorage.removeItem("barberpro_auth_token"),this.renderClientView(),this.showNotification("Você saiu da sua conta.")}handleLoginSubmit(e){const t=e.querySelector("#username"),o=e.querySelector("#password");t&&o&&this.login(t.value,o.value)||this.showNotification("Usuário ou senha inválidos.","error")}handleAppointmentSubmit(e,t){const o=e.get("name").trim(),i=this.sanitizePhone(e.get("phone"));if(!o||i.length<10||!e.get("service")||!e.get("barber"))return this.showNotification("Por favor, preencha todos os campos obrigatórios.","error");const n=t?this.getTodayDateString():e.get("date"),s=t?(new Date).toTimeString().slice(0,5):e.get("time"),a={id:Date.now().toString(),createdAt:(new Date).toISOString(),name:o,phone:i,service:e.get("service"),barberId:e.get("barber"),date:n,time:s,status:t?"in_progress":"scheduled",paymentStatus:"pending"};this.getOrUpdateClient(a.phone,a.name),this.appointments.push(a),this.saveData(),this.showNotification(t?"Comanda aberta com sucesso!":"Agendamento realizado com sucesso!","success"),this.hideModal(),this.currentUser&&this.renderRelevantViews()}startService(e){if(!this.checkCaixaStatus())return;const t=this.appointments.find(t=>t.id===e);t&&(t.status="in_progress",this.saveData(),this.hideModal(),this.showNotification("Atendimento iniciado! A comanda foi aberta.","success"),this.switchDashboardView("comandasView"))}
            
            finalizeAppointment(appointmentId, paymentMethod, finalPrice) {
                // BLOQUEIO DE CAIXA ADICIONADO AQUI
                if (!this.checkCaixaStatus()) {
                    return; 
                }
                const appointment = this.appointments.find(a => a.id === appointmentId);
                if (!appointment) return;
                const service = this.services.find(s => s.id === appointment.service);
                if (!service) return;

                if (isNaN(finalPrice) || finalPrice < 0) {
                    return this.showNotification('Por favor, insira um valor final válido.', 'error');
                }

                this.caixa.entradas.push({
                    descricao: `Serviço: ${service.name} (${appointment.name})`,
                    valor: finalPrice,
                    data: new Date().toISOString(),
                    metodo: paymentMethod
                });
                appointment.status = 'completed';
                appointment.paymentStatus = 'paid';
                appointment.paymentMethod = paymentMethod;
                appointment.finalPrice = finalPrice;
                appointment.closedAt = new Date().toISOString();
                this.saveData();
                this.hideModal();
                this.showNotification(`Pagamento de ${this.formatCurrency(finalPrice)} recebido!`, 'success');
                this.renderRelevantViews();
            }
            cancelAppointment(id){if(confirm("Tem certeza que deseja cancelar este agendamento?")){const e=this.appointments.find(e=>e.id===id);e&&(e.status="cancelled",this.saveData(),this.hideModal(),this.renderRelevantViews(),this.showNotification("Agendamento cancelado."))}}checkCaixaStatus(e=!1){return"fechado"===this.caixa.status?(e||(this.showNotification("O caixa está fechado. É preciso abri-lo para esta operação.","error"),this.showAbrirCaixaModal()),!1):!0}abrirCaixa(e){isNaN(e)||e<0?this.showNotification("Valor inicial inválido.","error"):(this.caixa={status:"aberto",saldoInicial:e,abertura:(new Date).toISOString(),entradas:[],saidas:[]},this.saveData(),this.hideModal(),this.updateCaixaStatusIndicator(),this.renderFinancialPage(),this.showNotification(`Caixa aberto com ${this.formatCurrency(e)}!`,"success"))}fecharCaixa(e){if(isNaN(e)||e<0)return this.showNotification("Valor conferido em dinheiro é inválido.","error");const t=this.caixa.entradas.reduce((e,t)=>e+t.valor,0),o=this.caixa.saidas.reduce((e,t)=>e+t.valor,0),i=this.caixa.entradas.filter(e=>"Dinheiro"===e.metodo).reduce((e,t)=>e+t.valor,0),n=this.caixa.saldoInicial+i-o;this.caixaHistory.push({abertura:this.caixa.abertura,fechamento:(new Date).toISOString(),saldoInicial:this.caixa.saldoInicial,totalEntradas:t,totalSaidas:o,saldoEsperadoDinheiro:n,dinheiroConferido:e,diferenca:e-n}),this.caixa={status:"fechado",saldoInicial:0,abertura:null,entradas:[],saidas:[]},this.saveData(),this.hideModal(),this.updateCaixaStatusIndicator(),this.renderFinancialPage(),this.showNotification("Caixa fechado e salvo no histórico.","success")}loadDashboardData(){this.currentUser&&(this.updateCaixaStatusIndicator(),this.updateStats(),this.renderDashboardAppointments(),(()=>{const e=document.getElementById("welcomeOpenCaixaBtn");e&&(e.style.display="fechado"===this.caixa.status?"inline-block":"none")})())}updateStats(){const e=this.getTodayDateString(),t=this.appointments.filter(t=>t.date===e&&"scheduled"===t.status),o=(this.caixa.entradas||[]).filter(t=>t.data.startsWith(e)).reduce((e,t)=>e+t.valor,0),i=this.appointments.filter(e=>"in_progress"===e.status).length;document.getElementById("todayCount").textContent=t.length,document.getElementById("pendingCount").textContent=i,document.getElementById("todayProfit").textContent=this.formatCurrency(o)}renderDashboardAppointments(){const e=document.getElementById("appointmentsList");if(e){const t=this.getTodayDateString(),o=this.appointments.filter(e=>e.date>=t&&("scheduled"===e.status||"in_progress"===e.status)).sort((e,t)=>(e.date+e.time).localeCompare(t.date+t.time)).slice(0,5);e.innerHTML=0===o.length?'<p class="empty-state">Nenhum agendamento futuro.</p>':o.map(e=>this.createAppointmentCard(e)).join("")}}renderPendingAppointments(){const e=document.getElementById("pendingAppointmentsList");e&&(e.innerHTML=this.appointments.filter(e=>"in_progress"===e.status).map(e=>this.createAppointmentCard(e)).join("")||'<p class="empty-state">Nenhuma comanda em andamento.</p>')}renderAgendaView(){const e=document.getElementById("agendaViewContainer"),t=document.getElementById("agendaDateFilter");if(e&&t&&0!==this.barbers.length){const o=t.value;e.innerHTML="";const i=[];for(let e=9;e<19;e++){if(12===e||13===e)continue;for(let t=0;t<60;t+=15)i.push(`${String(e).padStart(2,"0")}:${String(t).padStart(2,"0")}`)}const n=20,s='<div class="agenda-time-column">'+i.map(e=>`<div class="agenda-time-slot" style="height: ${n}px;">${e.endsWith(":00")?`<b>${e}</b>`:e}</div>`).join("")+"</div>";let a=`<div class="agenda-barbers-area" style="grid-template-columns: repeat(${this.barbers.length}, 1fr);">`;this.barbers.forEach(t=>{a+=`<div class="agenda-barber-column"><div class="agenda-barber-header">${t.name}</div><div class="agenda-slots-container" style="height: ${i.length*n}px;">`,this.appointments.filter(e=>e.barberId===t.id&&e.date===o&&"cancelled"!==e.status).forEach(t=>{const o=this.services.find(e=>e.id===t.service);if(o&&t.time)try{const[e,i]=t.time.split(":").map(Number);let s=(e-9)*60+i;e>=14&&(s-=120);const r=s/15*n,l=o.duration/15*n;a+=`<div class="agenda-appointment-block status-${t.status}" data-id="${t.id}" data-action="open-comanda-modal" style="top: ${r}px; height: ${l}px;"><strong class="appointment-block-name">${t.time} - ${t.name}</strong><span class="appointment-block-service">${o.name}</span></div>`}catch(e){console.error("Erro ao renderizar agendamento:",t,e)}}),a+="</div></div>"}),a+="</div>",e.innerHTML=s+a}else e&&(e.innerHTML='<p class="empty-state">Cadastre um profissional primeiro.</p>')}createAppointmentCard(e){const t=this.services.find(t=>t.id===e.service),o=this.barbers.find(t=>t.id===e.barberId),i={scheduled:{text:"Agendado"},completed:{text:"Concluído"},cancelled:{text:"Cancelado"},in_progress:{text:"Em Andamento"}},n=i[e.status]||{text:"Pendente"};return`<div class="appointment-card" data-id="${e.id}" data-action="open-comanda-modal"><div class="appointment-header"><div><h4>${e.name}</h4><p>${this.formatDate(e.date)} - ${e.time}h</p></div><div><p>${o?.name||"N/A"}</p><span class="appointment-status status-${e.status}">${n.text}</span></div></div><div class="appointment-footer"><p>${t?.name||"Serviço"} - <strong>${this.formatCurrency(t?.price||0)}</strong></p></div></div>`}renderFullClientsList(){const e=document.getElementById("fullClientsList"),t=document.getElementById("clientSearchInput").value.toLowerCase();e&&(e.innerHTML=this.clients.filter(e=>e.name.toLowerCase().includes(t)||e.phone.includes(t)).sort((e,t)=>e.name.localeCompare(t.name)).map(e=>`<div class="data-card"><div><strong>${e.name}</strong><div class="data-card-info"><span>📞 ${e.phone}</span></div></div><div class="data-card-actions"><button class="btn-secondary btn-small" data-action="view-client-details" data-id="${e.phone}">Ver Detalhes</button></div></div>`).join("")||'<p class="empty-state">Nenhum cliente encontrado.</p>')}renderServicesList(){const e=document.getElementById("servicesList");e&&(e.innerHTML=this.services.map(e=>`<div class="data-card"><div><strong>${e.name}</strong><div class="data-card-info"><span>💰 ${this.formatCurrency(e.price)}</span><span>⏱️ ${e.duration} min</span></div></div><div class="data-card-actions"><button class="btn-secondary btn-small" data-action="edit-service" data-id="${e.id}">Editar</button><button class="btn-secondary btn-danger btn-small" data-action="delete-service" data-id="${e.id}">Excluir</button></div></div>`).join(""))}renderProfessionalsList(){const e=document.getElementById("professionalsList");e&&(e.innerHTML=this.barbers.map(e=>`<div class="data-card"><div><strong>${e.name}</strong><div class="data-card-info"><span>${e.specialty||"Sem especialidade"}</span></div></div><div class="data-card-actions"><button class="btn-secondary btn-small" data-action="edit-professional" data-id="${e.id}">Editar</button><button class="btn-secondary btn-danger btn-small" data-action="delete-professional" data-id="${e.id}">Excluir</button></div></div>`).join(""))}renderFinancialPage(){const e=document.getElementById("financialDashboard"),[t,o,i]=["openCaixaBtn","closeCaixaBtn","addExpenseBtnMain"].map(e=>document.getElementById(e));e&&t&&o&&i&&("aberto"===this.caixa.status?(t.style.display="none",o.style.display="inline-block",i.style.display="inline-block",(()=>{const t=this.caixa.entradas.reduce((e,t)=>e+t.valor,0),o=this.caixa.saidas.reduce((e,t)=>e+t.valor,0),i=this.caixa.saldoInicial+t-o;e.innerHTML=`<div class="financial-summary"><div class="summary-item"><p>Saldo Inicial</p><h4>${this.formatCurrency(this.caixa.saldoInicial)}</h4></div><div class="summary-item"><p>Entradas</p><h4 class="text-green">${this.formatCurrency(t)}</h4></div><div class="summary-item"><p>Saídas</p><h4 class="text-red">${this.formatCurrency(o)}</h4></div><div class="summary-item total"><p>Saldo Atual</p><h4>${this.formatCurrency(i)}</h4></div></div>`})()):(t.style.display="inline-block",o.style.display="none",i.style.display="none",e.innerHTML='<div class="empty-state"><h3>Caixa Fechado</h3><p>Clique em "Abrir Caixa" para iniciar as operações.</p></div>'))}renderCharts(){Object.values(this.charts).forEach(e=>e.destroy()),this.renderRevenueChart(),this.renderServicesChart()}getOrUpdateClient(e,t){let o=this.clients.find(t=>t.phone===e);o?o.name!==t&&(o.name=t):this.clients.push({phone:e,name:t,createdAt:(new Date).toISOString()})}
            
            saveService(formData) {
                const id = formData.get('id');
                const name = formData.get('name')?.trim();
                if (!name) return this.showNotification('O nome é obrigatório.', 'error');
                if (this.services.some(s => s.name.toLowerCase() === name.toLowerCase() && s.id !== id)) return this.showNotification('Já existe um serviço com este nome.', 'error');

                const serviceData = {
                    name,
                    price: this.parseCurrency(formData.get('price')),
                    duration: parseInt(formData.get('duration'), 10),
                    description: formData.get('description')?.trim() || ''
                };

                if (id) {
                    const index = this.services.findIndex(s => s.id === id);
                    if (index > -1) {
                        this.services[index] = { ...this.services[index], ...serviceData };
                    }
                } else {
                    this.services.push({
                        id: `s_${Date.now()}`,
                        ...serviceData
                    });
                }
                this.saveData();
                this.hideModal();
                this.renderServicesList();
                this.updateServiceDropdown();
                this.renderClientView();
                this.showNotification('Serviço salvo com sucesso!', 'success');
            }

            deleteService(id){if(this.services.length<=1)return this.showNotification("É necessário ter pelo menos um serviço.","error");confirm("Deseja remover este serviço?")&&(this.services=this.services.filter(e=>e.id!==id),this.saveData(),this.renderServicesList(),this.updateServiceDropdown(),this.renderClientView(),this.showNotification("Serviço removido."))}
            
            saveProfessional(formData) {
                const id = formData.get('id');
                const name = formData.get('name')?.trim();
                if (!name) return this.showNotification('O nome do profissional é obrigatório.', 'error');
                if (this.barbers.some(b => b.name.toLowerCase() === name.toLowerCase() && b.id !== id)) return this.showNotification('Já existe um profissional com este nome.', 'error');
                const professionalData = {
                    name,
                    specialty: formData.get('specialty')?.trim() || ''
                };
                if (id) {
                    const index = this.barbers.findIndex(b => b.id === id);
                    if (index > -1) this.barbers[index] = { ...this.barbers[index],
                        ...professionalData
                    };
                } else {
                    this.barbers.push({
                        id: `b_${Date.now()}`,
                        ...professionalData
                    });
                }
                this.saveData();
                this.hideModal();
                this.renderProfessionalsList();
                this.updateBarberDropdowns();
                this.renderClientView();
                this.showNotification('Profissional salvo com sucesso!', 'success');
            }

            deleteProfessional(id){if(this.barbers.length<=1)return this.showNotification("É necessário ter pelo menos um profissional.","error");confirm("Tem certeza que deseja remover este profissional?")&&(this.barbers=this.barbers.filter(e=>e.id!==id),this.saveData(),this.renderProfessionalsList(),this.updateBarberDropdowns(),this.renderClientView(),this.showNotification("Profissional removido."))}saveExpense(e){if(!this.checkCaixaStatus())return;const t=this.parseCurrency(e.get("amount")),o=e.get("description");o&&t>0?(this.caixa.saidas.push({descricao:o,valor:t,data:(new Date).toISOString()}),this.saveData(),this.hideModal(),this.renderFinancialPage(),this.updateCaixaStatusIndicator(),this.showNotification("Despesa registrada!","success")):this.showNotification("Preencha a descrição e um valor válido.","error")}
            
            showModal(title, content) {
                document.getElementById('modalTitle').textContent = title;
                document.getElementById('modalContent').innerHTML = content;
                document.getElementById('modalBackdrop').style.display = 'flex';
                document.body.classList.add('modal-open');
                const firstInput = document.querySelector('#modalContent input, #modalContent select');
                if (firstInput) firstInput.focus();
            }

            hideModal(){document.getElementById("modalBackdrop").style.display="none",document.body.classList.remove("modal-open")}showNotification(e,t="success"){const o=document.getElementById("notificationContainer");if(o){const i=document.createElement("div");i.className=`notification ${t}`,i.textContent=e,o.appendChild(i),setTimeout(()=>{i.style.opacity="0",setTimeout(()=>i.remove(),500)},3500)}}
            
            showServiceModal(id = null) {
                const service = id ? this.services.find(s => s.id === id) : {};
                const content = `
                    <form id="serviceForm">
                        <input type="hidden" name="id" value="${service.id || ''}">
                        <div class="form-group"><label>Nome</label><input type="text" name="name" value="${service.name || ''}" required></div>
                        <div class="form-group"><label>Preço (R$)</label><input type="text" name="price" placeholder="Ex: 35,00" value="${service.price || ''}" required></div>
                        <div class="form-group"><label>Duração (min)</label><input type="number" step="15" name="duration" value="${service.duration || '45'}" required></div>
                        <div class="form-group"><label>Descrição</label><input type="text" name="description" value="${service.description || ''}"></div>
                    </form>
                    <div class="modal-footer">
                        <div class="modal-footer-actions">
                            <button type="button" class="btn-secondary" onclick="window.barberPro.hideModal()">Cancelar</button>
                            <button type="submit" form="serviceForm" class="btn-primary">${service.id ? 'Salvar' : 'Adicionar'}</button>
                        </div>
                    </div>`;
                this.showModal(service.id ? 'Editar Serviço' : 'Adicionar Serviço', content);
            }

            showProfessionalModal(id = null) {
                const professional = id ? this.barbers.find(b => b.id === id) : {};
                const content = `
                    <form id="professionalForm">
                        <input type="hidden" name="id" value="${professional.id || ''}">
                        <div class="form-group"><label>Nome</label><input type="text" name="name" value="${professional.name || ''}" required></div>
                        <div class="form-group"><label>Especialidade</label><input type="text" name="specialty" value="${professional.specialty || ''}"></div>
                    </form>
                    <div class="modal-footer">
                        <div class="modal-footer-actions">
                            <button type="button" class="btn-secondary" onclick="window.barberPro.hideModal()">Cancelar</button>
                            <button type="submit" form="professionalForm" class="btn-primary">${id ? 'Salvar' : 'Adicionar'}</button>
                        </div>
                    </div>`;
                this.showModal(id ? 'Editar Profissional' : 'Adicionar Profissional', content);
            }
            showAppointmentModal(e){const t=document.getElementById("agendaDateFilter")?.value||this.getTodayDateString(),o=`<form id="barberBookingForm" data-walk-in="${!e}"><div class="form-group"><label>Cliente</label><input type="text" name="name" list="clientSuggestions" placeholder="Buscar ou cadastrar novo" required autocomplete="off"></div><div class="form-group"><label>Celular (DDD)</label><input type="tel" name="phone" placeholder="11999999999" required></div><div class="form-group"><label>Serviço</label><select name="service" required>${this.generateServiceOptions()}</select></div><div class="form-group"><label>Profissional</label><select name="barber" required>${this.generateBarberOptions()}</select></div>${e?`<div class="form-group"><label>Data</label><input type="date" name="date" value="${t}" min="${this.getTodayDateString()}" required></div><div class="form-group"><label>Horário</label><select name="time" required>${this.generateTimeOptions()}</select></div>`:""}<div class="modal-footer"><div class="modal-footer-actions"><button type="button" class="btn-secondary" onclick="window.barberPro.hideModal()">Cancelar</button><button type="submit" class="btn-primary">Confirmar</button></div></div></form>${this.populateClientDatalist()}`;this.showModal(e?"Novo Agendamento":"Novo Atendimento (Encaixe)",o)}showClientDetailModal(e){const t=this.clients.find(t=>t.phone===e);if(t){const o=this.appointments.filter(t=>t.phone===e).sort((e,t)=>new Date(t.createdAt)-new Date(e.createdAt)),i={scheduled:"Agendado",completed:"Concluído",cancelled:"Cancelado",in_progress:"Em Andamento"};this.showModal("Detalhes do Cliente",`<div><h4>${t.name}</h4><p><strong>Telefone:</strong> ${t.phone}</p><p><strong>Cliente desde:</strong> ${this.formatDate(t.createdAt)}</p><hr><h5>Histórico</h5><div>${o.length>0?o.map(e=>`<div class="data-card"><span>${this.formatDate(e.date)}</span><span>${this.services.find(t=>t.id===e.service)?.name||""}</span><span class="appointment-status status-${e.status}">${i[e.status]||e.status}</span></div>`).join(""):"<p>Nenhum histórico.</p>"}</div></div>`)}}showCaixaHistoryModal(){this.showModal("Histórico de Caixa",`<div>${this.caixaHistory.sort((e,t)=>new Date(t.fechamento)-new Date(e.fechamento)).map(e=>`<div class="data-card"><div><strong>Fechamento:</strong> ${new Date(e.fechamento).toLocaleString("pt-BR")}</div><div>Faturamento: ${this.formatCurrency(e.totalEntradas)}</div><div class="${0!==e.diferenca?e.diferenca<0?"text-red":"text-green":""}">Diferença: ${this.formatCurrency(e.diferenca)}</div></div>`).join("")||'<p class="empty-state">Nenhum histórico.</p>'}</div>`)}showExpenseModal(){this.checkCaixaStatus()&&this.showModal("Adicionar Despesa",'<form id="expenseForm"><div class="form-group"><label>Descrição</label><input type="text" name="description" required></div><div class="form-group"><label>Valor (R$)</label><input type="text" name="amount" placeholder="Ex: 50,00" required></div><div class="modal-footer"><div class="modal-footer-actions"><button type="button" class="btn-secondary" onclick="window.barberPro.hideModal()">Cancelar</button><button type="submit" class="btn-primary">Adicionar Despesa</button></div></div></form>')}showAbrirCaixaModal(){this.showModal("Abrir Caixa",'<form id="openCaixaForm"><div class="form-group"><label>Valor Inicial (Troco)</label><input type="text" name="initialValue" placeholder="Ex: 100,00" required></div><div class="modal-footer"><div class="modal-footer-actions"><button type="button" class="btn-secondary" onclick="window.barberPro.hideModal()">Cancelar</button><button type="submit" class="btn-primary">Abrir Caixa</button></div></div></form>')}showFecharCaixaModal(){this.showModal("Fechar Caixa",'<form id="closeCaixaForm"><div class="form-group"><label>Dinheiro Contado na Gaveta</label><input type="text" name="countedCash" placeholder="Ex: 450,50" required></div><div class="modal-footer"><div class="modal-footer-actions"><button type="button" class="btn-secondary" onclick="window.barberPro.hideModal()">Cancelar</button><button type="submit" class="btn-primary">Fechar Caixa</button></div></div></form>')}showComandaActionsModal(e){const t=this.appointments.find(t=>t.id===e);if(t){const o=this.services.find(e=>e.id===t.service);let i="";"scheduled"===t.status?i='<button id="startServiceBtn" class="btn-primary">Iniciar Atendimento</button>':"in_progress"===t.status&&(i='<button id="finalizeServiceBtn" class="btn-primary">Finalizar e Receber</button>');const n=`<div><p><strong>Cliente:</strong> ${t.name}</p><p><strong>Serviço:</strong> ${o?.name}</p><p><strong>Valor:</strong> ${this.formatCurrency(o?.price||0)}</p></div><div class="modal-footer"><div><button type="button" class="btn-secondary btn-danger btn-small" data-action="cancel-appointment" data-id="${t.id}">Cancelar Agend.</button><button type="button" id="remindWhatsAppBtn" class="btn-secondary btn-small" style="margin-left: 0.5rem;"><i class="fab fa-whatsapp"></i> Lembrar</button></div><div class="modal-footer-actions"><button type="button" class="btn-secondary" onclick="window.barberPro.hideModal()">Fechar</button>${i}</div></div>`;this.showModal("Gerenciar Atendimento",n),document.getElementById("startServiceBtn")?.addEventListener("click",()=>this.startService(e)),document.getElementById("finalizeServiceBtn")?.addEventListener("click",()=>this.showFinalizeAppointmentModal(e)),document.getElementById("remindWhatsAppBtn")?.addEventListener("click",()=>this.sendWhatsAppReminder(e))}}showFinalizeAppointmentModal(e){const t=this.appointments.find(t=>t.id===e);if(t){const o=this.services.find(e=>e.id===t.service);this.showModal("Finalizar e Receber",`<form id="finalizeForm">
                    <p>Finalizando <strong>${t.name}</strong>.</p>
                    <div class="form-group">
                        <label for="finalPrice">Valor Final a Cobrar (R$)</label>
                        <input type="text" id="finalPrice" name="finalPrice" value="${(o?.price||0).toFixed(2)}" placeholder="Ex: 42,00" required>
                    </div>
                    <div class="form-group">
                        <label for="paymentMethod">Forma de Pagamento</label>
                        <select id="paymentMethod" name="paymentMethod" required>
                            <option value="Dinheiro">Dinheiro</option>
                            <option value="Pix">Pix</option>
                            <option value="Cartão de Débito">Cartão de Débito</option>
                            <option value="Cartão de Crédito">Cartão de Crédito</option>
                        </select>
                    </div>
                    <div class="modal-footer">
                        <div class="modal-footer-actions">
                            <button type="button" class="btn-secondary" onclick="window.barberPro.hideModal()">Cancelar</button>
                            <button type="submit" class="btn-primary">Confirmar Pagamento</button>
                        </div>
                    </div>
                </form>`),document.getElementById("finalizeForm")?.addEventListener("submit",t=>{t.preventDefault();const o=t.target,i=o.querySelector('[name="paymentMethod"]').value,n=this.parseCurrency(o.querySelector('[name="finalPrice"]').value);this.finalizeAppointment(e,i,n)})}}sendWhatsAppReminder(e){const t=this.appointments.find(t=>t.id===e);if(t){const o=t.name.split(" ")[0],i=t.time,n=this.formatDate(t.date),s=`Olá ${o}, passando para lembrar do seu agendamento na Steves Barbearia no dia ${n} às ${i}. Podemos confirmar?`;let a=this.sanitizePhone(t.phone);a.length>=10&&!a.startsWith("55")&&(a="55"+a),window.open(`https://wa.me/${a}?text=${encodeURIComponent(s)}`,"_blank"),this.showNotification("Abrindo WhatsApp para enviar lembrete.","success")}else this.showNotification("Agendamento não encontrado.","error")}parseCurrency(e){if("string"!=typeof e)return NaN;const t=e.replace(/[^0-9,.]/g,"").replace(",",".");return parseFloat(t)}updateServiceDropdown(){document.querySelectorAll('select[name="service"]').forEach(e=>e.innerHTML=this.generateServiceOptions())}updateBarberDropdowns(){document.querySelectorAll('select[name="barber"]').forEach(e=>e.innerHTML=this.generateBarberOptions())}updateTimeDropdown(){document.querySelectorAll('select[name="time"]').forEach(e=>e.innerHTML=this.generateTimeOptions())}formatCurrency(e){return new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(e||0)}formatDate(e){const t=new Date(e);return new Date(t.getTime()+6e4*t.getTimezoneOffset()).toLocaleDateString("pt-BR")}getTodayDateString(){return(new Date).toISOString().split("T")[0]}sanitizePhone(e){return String(e).replace(/\D/g,"")}setMinDate(){const e=document.getElementById("preferredDate");e&&(e.min=this.getTodayDateString())}navigateAgendaDays(e){const t=document.getElementById("agendaDateFilter");if(t.value){const o=new Date(t.value+"T00:00:00");o.setDate(o.getDate()+e),t.value=o.toISOString().split("T")[0],this.renderAgendaView()}}updateCaixaStatusIndicator(){const e=document.getElementById("caixaStatus");e&&("aberto"===this.caixa.status?(e.className="caixa-status-indicator aberto",e.innerHTML=`<span>Caixa Aberto: <strong>${this.formatCurrency(this.caixa.saldoInicial+this.caixa.entradas.reduce((e,t)=>e+t.valor,0)-this.caixa.saidas.reduce((e,t)=>e+t.valor,0))}</strong></span>`):(e.className="caixa-status-indicator fechado",e.innerHTML="<span>Caixa Fechado</span>"))}generateServiceOptions(){return'<option value="">Selecione</option>'+this.services.map(e=>`<option value="${e.id}">${e.name} - ${this.formatCurrency(e.price)}</option>`).join("")}generateBarberOptions(){return'<option value="">Selecione</option>'+this.barbers.map(e=>`<option value="${e.id}">${e.name}</option>`).join("")}generateTimeOptions(){let e='<option value="">Selecione</option>';for(let t=9;t<19;t++){if(12===t||13===t)continue;for(let o=0;o<60;o+=15){const i=`${String(t).padStart(2,"0")}:${String(o).padStart(2,"0")}`;e+=`<option value="${i}">${i}</option>`}}return e}renderRelevantViews(){if(this.currentUser){const e=document.querySelector('.content-view[style*="block"]')?.id;e?this.switchDashboardView(e):this.loadDashboardData()}}populateClientDatalist(){return`<datalist id="clientSuggestions">${this.clients.map(e=>`<option value="${e.name}"></option>`).join("")}</datalist>`}handleClientNameInput(e){const t=this.clients.find(t=>t.name.toLowerCase()===e.target.value.toLowerCase());t&&(e.target.closest("form").querySelector('input[name="phone"]').value=t.phone)}renderRevenueChart(){const e=document.getElementById("revenueChart")?.getContext("2d");if(e){const t=[],o=[];for(let i=6;i>=0;i--){const n=new Date;n.setDate(n.getDate()-i);const s=n.toISOString().split("T")[0];t.push(n.toLocaleDateString("pt-BR",{day:"2-digit",month:"2-digit"}));const a=this.appointments.filter(e=>e.date===s&&"completed"===e.status).reduce((e,t)=>e+(this.services.find(e=>e.id===t.service)?.price||0),0);o.push(a)}this.charts.revenue&&this.charts.revenue.destroy(),this.charts.revenue=new Chart(e,{type:"line",data:{labels:t,datasets:[{label:"Faturamento",data:o,borderColor:"hsl(43, 96%, 56%)",tension:.3,fill:!0,backgroundColor:"hsla(43, 96%, 56%, 0.1)"}]},options:{responsive:!0,maintainAspectRatio:!1,scales:{y:{beginAtZero:!0}}}})}}renderServicesChart(){const e=document.getElementById("servicesChart")?.getContext("2d");if(e){const t=this.appointments.filter(e=>"completed"===e.status).reduce((e,t)=>{const o=this.services.find(e=>e.id===t.service);return o&&(e[o.name]=(e[o.name]||0)+1),e},{}),o=Object.keys(t),i=Object.values(t);this.charts.services&&this.charts.services.destroy(),this.charts.services=new Chart(e,{type:"doughnut",data:{labels:o,datasets:[{label:"Atendimentos",data:i,backgroundColor:["#f59e0b","#8b5cf6","#3b82f6","#22c55e","#ef4444"],hoverOffset:4}]},options:{responsive:!0,maintainAspectRatio:!1}})}}
        }

        window.barberPro = new BarberPro();
    </script>
</body>
</html>
